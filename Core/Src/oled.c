#include "oled.h"
#include "stm32f1xx_hal_i2c.h"

#define OLED_I2C_ADDR (0b111100 << 1)
const uint8_t font6x8[][6] =
{
{0x00, 0x00, 0x00, 0x00, 0x00, 0x00},// sp
{0x00, 0x00, 0x00, 0x2f, 0x00, 0x00},// !
{0x00, 0x00, 0x07, 0x00, 0x07, 0x00},// "
{0x00, 0x14, 0x7f, 0x14, 0x7f, 0x14},// #
{0x00, 0x24, 0x2a, 0x7f, 0x2a, 0x12},// $
{0x00, 0x62, 0x64, 0x08, 0x13, 0x23},// %
{0x00, 0x36, 0x49, 0x55, 0x22, 0x50},// &
{0x00, 0x00, 0x05, 0x03, 0x00, 0x00},// '
{0x00, 0x00, 0x1c, 0x22, 0x41, 0x00},// (
{0x00, 0x00, 0x41, 0x22, 0x1c, 0x00},// )
{0x00, 0x14, 0x08, 0x3E, 0x08, 0x14},// *
{0x00, 0x08, 0x08, 0x3E, 0x08, 0x08},// +
{0x00, 0x00, 0x00, 0xA0, 0x60, 0x00},// ,
{0x00, 0x08, 0x08, 0x08, 0x08, 0x08},// -
{0x00, 0x00, 0x60, 0x60, 0x00, 0x00},// .
{0x00, 0x20, 0x10, 0x08, 0x04, 0x02},// /
{0x00, 0x3E, 0x51, 0x49, 0x45, 0x3E},// 0
{0x00, 0x00, 0x42, 0x7F, 0x40, 0x00},// 1
{0x00, 0x42, 0x61, 0x51, 0x49, 0x46},// 2
{0x00, 0x21, 0x41, 0x45, 0x4B, 0x31},// 3
{0x00, 0x18, 0x14, 0x12, 0x7F, 0x10},// 4
{0x00, 0x27, 0x45, 0x45, 0x45, 0x39},// 5
{0x00, 0x3C, 0x4A, 0x49, 0x49, 0x30},// 6
{0x00, 0x01, 0x71, 0x09, 0x05, 0x03},// 7
{0x00, 0x36, 0x49, 0x49, 0x49, 0x36},// 8
{0x00, 0x06, 0x49, 0x49, 0x29, 0x1E},// 9
{0x00, 0x00, 0x36, 0x36, 0x00, 0x00},// :
{0x00, 0x00, 0x56, 0x36, 0x00, 0x00},// ;
{0x00, 0x08, 0x14, 0x22, 0x41, 0x00},// <
{0x00, 0x14, 0x14, 0x14, 0x14, 0x14},// =
{0x00, 0x00, 0x41, 0x22, 0x14, 0x08},// >
{0x00, 0x02, 0x01, 0x51, 0x09, 0x06},// ?
{0x00, 0x32, 0x49, 0x59, 0x51, 0x3E},// @
{0x00, 0x7C, 0x12, 0x11, 0x12, 0x7C},// A
{0x00, 0x7F, 0x49, 0x49, 0x49, 0x36},// B
{0x00, 0x3E, 0x41, 0x41, 0x41, 0x22},// C
{0x00, 0x7F, 0x41, 0x41, 0x22, 0x1C},// D
{0x00, 0x7F, 0x49, 0x49, 0x49, 0x41},// E
{0x00, 0x7F, 0x09, 0x09, 0x09, 0x01},// F
{0x00, 0x3E, 0x41, 0x49, 0x49, 0x7A},// G
{0x00, 0x7F, 0x08, 0x08, 0x08, 0x7F},// H
{0x00, 0x00, 0x41, 0x7F, 0x41, 0x00},// I
{0x00, 0x20, 0x40, 0x41, 0x3F, 0x01},// J
{0x00, 0x7F, 0x08, 0x14, 0x22, 0x41},// K
{0x00, 0x7F, 0x40, 0x40, 0x40, 0x40},// L
{0x00, 0x7F, 0x02, 0x0C, 0x02, 0x7F},// M
{0x00, 0x7F, 0x04, 0x08, 0x10, 0x7F},// N
{0x00, 0x3E, 0x41, 0x41, 0x41, 0x3E},// O
{0x00, 0x7F, 0x09, 0x09, 0x09, 0x06},// P
{0x00, 0x3E, 0x41, 0x51, 0x21, 0x5E},// Q
{0x00, 0x7F, 0x09, 0x19, 0x29, 0x46},// R
{0x00, 0x46, 0x49, 0x49, 0x49, 0x31},// S
{0x00, 0x01, 0x01, 0x7F, 0x01, 0x01},// T
{0x00, 0x3F, 0x40, 0x40, 0x40, 0x3F},// U
{0x00, 0x1F, 0x20, 0x40, 0x20, 0x1F},// V
{0x00, 0x3F, 0x40, 0x38, 0x40, 0x3F},// W
{0x00, 0x63, 0x14, 0x08, 0x14, 0x63},// X
{0x00, 0x07, 0x08, 0x70, 0x08, 0x07},// Y
{0x00, 0x61, 0x51, 0x49, 0x45, 0x43},// Z
{0x00, 0x00, 0x7F, 0x41, 0x41, 0x00},// [
{0x00, 0x55, 0x2A, 0x55, 0x2A, 0x55},// 55
{0x00, 0x00, 0x41, 0x41, 0x7F, 0x00},// ]
{0x00, 0x04, 0x02, 0x01, 0x02, 0x04},// ^
{0x00, 0x40, 0x40, 0x40, 0x40, 0x40},// _
{0x00, 0x00, 0x01, 0x02, 0x04, 0x00},// '
{0x00, 0x20, 0x54, 0x54, 0x54, 0x78},// a
{0x00, 0x7F, 0x48, 0x44, 0x44, 0x38},// b
{0x00, 0x38, 0x44, 0x44, 0x44, 0x20},// c
{0x00, 0x38, 0x44, 0x44, 0x48, 0x7F},// d
{0x00, 0x38, 0x54, 0x54, 0x54, 0x18},// e
{0x00, 0x08, 0x7E, 0x09, 0x01, 0x02},// f
{0x00, 0x18, 0xA4, 0xA4, 0xA4, 0x7C},// g
{0x00, 0x7F, 0x08, 0x04, 0x04, 0x78},// h
{0x00, 0x00, 0x44, 0x7D, 0x40, 0x00},// i
{0x00, 0x40, 0x80, 0x84, 0x7D, 0x00},// j
{0x00, 0x7F, 0x10, 0x28, 0x44, 0x00},// k
{0x00, 0x00, 0x41, 0x7F, 0x40, 0x00},// l
{0x00, 0x7C, 0x04, 0x18, 0x04, 0x78},// m
{0x00, 0x7C, 0x08, 0x04, 0x04, 0x78},// n
{0x00, 0x38, 0x44, 0x44, 0x44, 0x38},// o
{0x00, 0xFC, 0x24, 0x24, 0x24, 0x18},// p
{0x00, 0x18, 0x24, 0x24, 0x18, 0xFC},// q
{0x00, 0x7C, 0x08, 0x04, 0x04, 0x08},// r
{0x00, 0x48, 0x54, 0x54, 0x54, 0x20},// s
{0x00, 0x04, 0x3F, 0x44, 0x40, 0x20},// t
{0x00, 0x3C, 0x40, 0x40, 0x20, 0x7C},// u
{0x00, 0x1C, 0x20, 0x40, 0x20, 0x1C},// v
{0x00, 0x3C, 0x40, 0x30, 0x40, 0x3C},// w
{0x00, 0x44, 0x28, 0x10, 0x28, 0x44},// x
{0x00, 0x1C, 0xA0, 0xA0, 0xA0, 0x7C},// y
{0x00, 0x44, 0x64, 0x54, 0x4C, 0x44},// z
{0x14, 0x14, 0x14, 0x14, 0x14, 0x14},// horiz lines
};

void oled_command_1(I2C_HandleTypeDef *i2c, uint8_t cmd0) {
  uint8_t data[2];
  data[0] = 0;
  data[1] = cmd0;
  HAL_I2C_Master_Transmit(i2c, OLED_I2C_ADDR, data, 2, 1);
}

void oled_command_2(I2C_HandleTypeDef *i2c, uint8_t cmd0, uint8_t cmd1) {
  uint8_t data[3];
  data[0] = 0;
  data[1] = cmd0;
  data[2] = cmd1;
  HAL_I2C_Master_Transmit(i2c, OLED_I2C_ADDR, data, 3, 1);
}

void oled_command_3(I2C_HandleTypeDef *i2c, uint8_t cmd0, uint8_t cmd1, uint8_t cmd2) {
  uint8_t data[4];
  data[0] = 0;
  data[1] = cmd0;
  data[2] = cmd1;
  data[3] = cmd2;
  HAL_I2C_Master_Transmit(i2c, OLED_I2C_ADDR, data, 4, 1);
}

void oled_clear(I2C_HandleTypeDef *i2c) {
  uint8_t data[129];
  data[0] = 0x40;
  for (int i = 1; i < 129; i++)
    data[i] = 0;

  for(int i=0; i<8; i++)
	{
    oled_command_3(i2c, 0xb0 + i, 0x00, 0x10); // set address
    HAL_I2C_Master_Transmit(i2c, OLED_I2C_ADDR, data, 129, 10);
	}
}

void oled_test_seq(I2C_HandleTypeDef *i2c) {
  oled_command_2(i2c, 0x20, 0x00); // horizontal addressing mode
  oled_command_3(i2c, 0x22, 0, 7); // set page start/end
  uint8_t data[2];
  data[0] = 0x40;
  for (int m = 0; m < 2; m++) {
    if (m == 0)
      data[1] = 0xff;
    else
      data[1] = 0x00;

    for(int i=0; i<8; i++)
    {
      for(int j=1; j<129; j++) {
        HAL_I2C_Master_Transmit(i2c, OLED_I2C_ADDR, data, 2, 1);
        HAL_Delay(2);
      }
    }
  }
}

void oled_init(struct oled_handle *handle) {
  HAL_GPIO_WritePin(handle->rst_port, handle->rst_pin, GPIO_PIN_RESET);
  HAL_Delay(1);
  HAL_GPIO_WritePin(handle->pwr_port, handle->pwr_pin, GPIO_PIN_SET);
  HAL_Delay(100);
  HAL_GPIO_WritePin(handle->rst_port, handle->rst_pin, GPIO_PIN_SET);
  HAL_Delay(1);

  oled_clear(handle->i2c);

  uint8_t cmd[] = {
    0x00,
    0xA1, 0xC8,  // rotate display 180 degrees
    0x8D, 0x14,  // enable charge pump
    0xAF,        // display on
  };
  HAL_I2C_Master_Transmit(handle->i2c, OLED_I2C_ADDR, cmd, sizeof(cmd), 1);
}

void oled_set_pos(I2C_HandleTypeDef *i2c, uint8_t x, uint8_t y) {
  oled_command_3(i2c, 0xb0 + y, x & 0xf, 0x10 | (x >> 4));
}

void oled_text_mode_init(struct oled_text_mode *txt, struct oled_handle *handle) {
  txt->i2c = handle->i2c;
  txt->x = 0;
  txt->y = 0;
  oled_command_2(txt->i2c, 0x20, 0b10);  // Page Addressing Mode
  oled_set_pos(txt->i2c, txt->x, txt->y);
}

void oled_write_string(struct oled_text_mode *txt, const char *str) {
  while (*str) {
    if (*str == '\n') {
      txt->x = 0;
      txt->y++;
      if (txt->y > 7)
        txt->y = 0;
      oled_set_pos(txt->i2c, txt->x, txt->y);
    } else if (*str == '\r') {
      txt->x = 0;
      oled_set_pos(txt->i2c, txt->x, txt->y);
    } else if (*str == '\t') {
      txt->x = txt->x + 4*6 - txt->x % (4*6);
      if (txt->x > 120) {
        txt->x = 0;
        txt->y++;
        if (txt->y > 7)
          txt->y = 0;
      }
      oled_set_pos(txt->i2c, txt->x, txt->y);
    } else {
      uint8_t data[7];
      data[0] = 0x40;
      if (*str >= ' ' && *str <= '~') {
        for (int i = 0; i < 6; i++)
          data[i + 1] = font6x8[*str - ' '][i];
      } else {
        for (int i = 0; i < 6; i++)
          data[i + 1] = ~font6x8['?' - ' '][i];
      }
      HAL_I2C_Master_Transmit(txt->i2c, OLED_I2C_ADDR, data, 7, 1);
      txt->x += 6;
      if (txt->x > 120) {
        txt->x = 0;
        txt->y++;
        if (txt->y > 7) {
          txt->y = 0;
        }
        oled_set_pos(txt->i2c, txt->x, txt->y);
      }
    }
    str++;
  }
}
